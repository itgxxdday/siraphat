<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üíß Droplet Image Analyzer (Web)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <header class="p-3 mb-4 text-white text-center">
        <h1 class="display-5"><i class="fas fa-water"></i> Droplet Image Analyzer</h1>
        <p class="lead">‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢‡∏ï‡∏±‡∏ß‡∏Ç‡∏≠‡∏á‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏ù‡∏≠‡∏¢</p>
    </header>

    <div class="container my-5">
        <div class="row">
            <div class="col-lg-4 mb-4">
                <div class="card shadow-sm p-4 sticky-top">
                    <h5 class="card-title text-primary"><i class="fas fa-cogs"></i> 1. ‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</h5>
                    <form id="analysisForm" enctype="multipart/form-data">
                        <div class="mb-3">
                            <label for="fileInput" class="form-label">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏†‡∏≤‡∏û‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏ï‡∏£‡∏ß‡∏à‡∏´‡∏¢‡∏î (.jpg, .png)</label>
                            <input class="form-control" type="file" id="fileInput" name="file" accept="image/*" required>
                        </div>
                        <div class="row g-2 mb-3">
                            <div class="col-6">
                                <label for="paper_width" class="form-label">‡∏Å‡∏ß‡πâ‡∏≤‡∏á (cm)</label>
                                <input type="number" step="0.01" class="form-control" id="paper_width" name="paper_width" placeholder="‡πÄ‡∏ä‡πà‡∏ô 10.0" required>
                            </div>
                            <div class="col-6">
                                <label for="paper_height" class="form-label">‡∏¢‡∏≤‡∏ß (cm)</label>
                                <input type="number" step="0.01" class="form-control" id="paper_height" name="paper_height" placeholder="‡πÄ‡∏ä‡πà‡∏ô 7.5" required>
                            </div>
                        </div>
                        <button type="submit" class="btn btn-primary w-100" id="submitBtn">
                            <span id="btnText"><i class="fas fa-play"></i> ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</span>
                            <div class="spinner-border spinner-border-sm" role="status" id="loadingSpinner" style="display:none;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                        </button>
                    </form>
                    <div id="alertMessage" class="mt-3 alert alert-danger" style="display:none;"></div>
                </div>
            </div>

            <div class="col-lg-8">
                <div class="card shadow-lg p-4" id="resultsCard" style="display:none;">
                    <h5 class="card-title text-success mb-4"><i class="fas fa-chart-bar"></i> 2. ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</h5>
                    
                    <div class="p-3 mb-4 rounded-3 text-white" id="efficacyBox">
                        <h4 class="mb-1">üìä ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏ô‡∏≤‡πÅ‡∏ô‡πà‡∏ô‡∏ï‡πà‡∏≠ 1 ‡∏ï‡∏£.‡∏ã‡∏°.</h4>
                        <p class="h1 mb-0" id="densityResult">--</p>
                        <hr>
                        <p class="h5 mb-0" id="efficacyText"></p>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <div class="data-box">
                                <i class="fas fa-tint text-primary"></i>
                                <strong>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏´‡∏¢‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏û‡∏ö:</strong> <span id="countResult">--</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="data-box">
                                <i class="fas fa-percent text-success"></i>
                                <strong>‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏à‡∏≤‡∏¢:</strong> <span id="coverageResult">--</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="data-box">
                                <i class="fas fa-ruler-combined text-info"></i>
                                <strong>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏∞‡∏≠‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á:</strong> <span id="dropAreaResult">--</span>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="data-box">
                                <i class="fas fa-file-alt text-warning"></i>
                                <strong>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡∏à‡∏£‡∏¥‡∏á:</strong> <span id="paperAreaResult">--</span>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <h5 class="mt-4 mb-3 text-primary"><i class="fas fa-image"></i> ‡∏†‡∏≤‡∏û‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå</h5>
                    <div class="row">
                        <div class="col-md-6 text-center">
                            <strong>‡∏†‡∏≤‡∏û‡∏ï‡πâ‡∏ô‡∏â‡∏ö‡∏±‡∏ö</strong>
                            <img id="originalImage" class="img-fluid rounded shadow-sm mt-2" alt="Original Image">
                        </div>
                        <div class="col-md-6 text-center">
                            <strong>‡∏†‡∏≤‡∏û‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå (‡∏°‡∏µ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï)</strong>
                            <img id="outputImage" class="img-fluid rounded shadow-sm mt-2" alt="Output Image">
                        </div>
                    </div>
                </div>
                 <div id="initialMessage" class="text-center p-5 bg-light rounded-3 shadow-sm">
                    <i class="fas fa-upload fa-4x text-muted mb-3"></i>
                    <p class="lead">‡πÇ‡∏õ‡∏£‡∏î‡∏õ‡πâ‡∏≠‡∏ô‡∏Ç‡∏ô‡∏≤‡∏î‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå</p>
                </div>
            </div>
        </div>
    </div>

    <footer class="text-center p-3 mt-5 text-muted border-top">
        Droplet Analyzer by Gemini AI | Powered by Flask & OpenCV
    </footer>

    <script src="https://kit.fontawesome.com/4a8607144e.js" crossorigin="anonymous"></script> 
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.getElementById('analysisForm').addEventListener('submit', function(e) {
            e.preventDefault();

            const form = e.target;
            const formData = new FormData(form);
            const submitBtn = document.getElementById('submitBtn');
            const btnText = document.getElementById('btnText');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const alertMessage = document.getElementById('alertMessage');
            const resultsCard = document.getElementById('resultsCard');
            const initialMessage = document.getElementById('initialMessage');

            // 1. UI Feedback: Loading State
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            loadingSpinner.style.display = 'inline-block';
            alertMessage.style.display = 'none';
            
            // 2. API Call
            fetch('/analyze', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // 3. Handle Result
                if (data.success) {
                    const results = data.results;

                    // Update Result Boxes
                    document.getElementById('countResult').textContent = results.count;
                    document.getElementById('coverageResult').textContent = results.percent_coverage;
                    document.getElementById('dropAreaResult').textContent = results.drop_area_real;
                    document.getElementById('paperAreaResult').textContent = results.paper_area_real;
                    
                    // Update Density Box
                    document.getElementById('densityResult').textContent = results.droplets_per_sq_cm;
                    document.getElementById('efficacyText').textContent = `‡∏Å‡∏≤‡∏£‡πÅ‡∏õ‡∏•‡∏ú‡∏•: ${results.efficacy_result}`;
                    
                    // Set color based on efficacy
                    const density = parseFloat(results.droplets_per_sq_cm.split(' ')[0]);
                    const efficacyBox = document.getElementById('efficacyBox');
                    efficacyBox.className = 'p-3 mb-4 rounded-3 text-white'; // Reset class
                    
                    if (density > 50) {
                        efficacyBox.classList.add('bg-success');
                    } else if (density >= 30) {
                        efficacyBox.classList.add('bg-info');
                    } else if (density >= 20) {
                        efficacyBox.classList.add('bg-warning');
                    } else {
                        efficacyBox.classList.add('bg-danger');
                    }

                    // Update Images
                    document.getElementById('originalImage').src = data.original_image;
                    document.getElementById('outputImage').src = data.output_image;
                    
                    // Show Results and Hide Initial Message
                    initialMessage.style.display = 'none';
                    resultsCard.style.display = 'block';

                } else {
                    // Show Error
                    alertMessage.textContent = `‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ${data.error}`;
                    alertMessage.style.display = 'block';
                    resultsCard.style.display = 'none';
                }
            })
            .catch(error => {
                // Network/System Error
                console.error('Fetch Error:', error);
                alertMessage.textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö‡πÄ‡∏ã‡∏¥‡∏£‡πå‡∏ü‡πÄ‡∏ß‡∏≠‡∏£‡πå';
                alertMessage.style.display = 'block';
                resultsCard.style.display = 'none';
            })
            .finally(() => {
                // 4. UI Feedback: Reset State
                submitBtn.disabled = false;
                btnText.style.display = 'inline';
                loadingSpinner.style.display = 'none';
            });
        });
    </script>
</body>
</html>